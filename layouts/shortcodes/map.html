{{ $loc := .Get "loc" }}
{{ if not $loc }}
<p class="mb-map-error">No location provided for map shortcode.</p>
{{ else }}
{{ $zoom := .Get "zoom" | default .Site.Params.default_map_zoom | default "14" }}
{{ $marker := .Get "marker" | default "" }}
{{ $id := printf "mb-map-%d" (now.UnixNano) }}
{{ $previewStyle := .Site.Params.map_preview_style | default "" }}
{{ $previewStyleLight := .Site.Params.map_preview_style_light | default "" }}
{{ $previewStyleDark := .Site.Params.map_preview_style_dark | default "" }}
{{ $previewApiKey := .Site.Params.map_preview_api_key | default "" }}
{{ if not (.Page.Scratch.Get "mb-map-style-loaded") }}
{{ .Page.Scratch.Set "mb-map-style-loaded" true }}
<style>
.mb-map-wrapper {
  position: relative;
  padding-bottom: 56.25%;
  height: 0;
  overflow: hidden;
  background-color: #eef2f4;
  max-width: 100%;
  border-radius: 8px;
}
.mb-map-canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  color: #1b1b1b;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 1rem;
}
.mb-map-canvas--preview {
  flex-direction: column;
  gap: 1rem;
  cursor: pointer;
}
.mb-map-canvas--preview * {
  cursor: inherit;
}
.mb-map-canvas--fallback {
  background: repeating-linear-gradient(
      45deg,
      rgba(27, 27, 27, 0.08) 0,
      rgba(27, 27, 27, 0.08) 12px,
      rgba(27, 27, 27, 0.14) 12px,
      rgba(27, 27, 27, 0.14) 24px
    )
    #eef2f4;
}
.mb-map-preview-image {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}
.mb-map-preview-fallback-text {
  margin: 0 0 0.75rem;
  padding: 0.75rem 1rem;
  font-size: 0.95rem;
  font-weight: 500;
  color: #1f2937;
  text-align: center;
  background: rgba(255, 255, 255, 0.85);
  border-radius: 8px;
  box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
}
.mb-map-preview-controls {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  margin-top: clamp(3.5rem, 24vh, 11rem);
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.65);
}
.mb-map-canvas--fallback .mb-map-preview-controls {
  color: #1f2937;
  text-shadow: none;
}
.mb-map-canvas--fallback .mb-map-preview-controls p {
  color: inherit;
}
.mb-map-preview-caption {
  margin: 0;
  padding: 0.65rem 1rem;
  font-size: 0.95rem;
  font-weight: 500;
  color: inherit;
  background: rgba(0, 0, 0, 0.5);
  border-radius: 8px;
}
.mb-map-wrapper .leaflet-container {
  width: 100%;
  height: 100%;
}
.mb-map-loading-text {
  padding: 0.5rem 1rem;
  border-radius: 999px;
  background: rgba(27, 27, 27, 0.85);
  color: #fff;
  font-weight: 600;
  font-size: 0.95rem;
}
.mb-map-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.65);
  color: #fff;
  text-align: center;
  font-size: 0.85em;
  padding: 0.5em 1em;
  z-index: 5;
  pointer-events: none;
}
.mb-map-error {
  margin: 1rem 0;
  padding: 0.75rem 1rem;
  border-radius: 6px;
  background: #fee2e2;
  color: #991b1b;
}
</style>
{{ end }}
<div class="mb-map-wrapper" data-mb-map="true" data-map-id="{{ $id }}" data-loc="{{ $loc | htmlEscape }}" data-zoom="{{ $zoom }}" data-marker="{{ $marker | htmlEscape }}" data-preview-style="{{ $previewStyle | htmlEscape }}" data-preview-style-light="{{ $previewStyleLight | htmlEscape }}" data-preview-style-dark="{{ $previewStyleDark | htmlEscape }}" data-preview-key="{{ $previewApiKey | htmlEscape }}">
  <div id="{{ $id }}" class="mb-map-canvas">Loading map…</div>
  {{ if .Site.Params.show_privacy_notice }}
    {{ $privacyText := .Site.Params.map_privacy_notice_text }}
    <div class="mb-map-overlay">
      {{ with $privacyText }}
        {{ . }}
      {{ else }}
        Map data © OpenStreetMap contributors.
      {{ end }}
    </div>
  {{ end }}
</div>
<noscript>
  <p class="mb-map-error">Maps require JavaScript to display.</p>
</noscript>
<script>
(function() {
  if (!window.__mbMapEnsureLeaflet) {
    window.__mbMapPending = [];
    window.__mbMapEnsureLeaflet = function(callback) {
      if (window.__mbMapLeafletFailed) {
        callback();
        return;
      }
      if (window.L && window.L.map) {
        callback();
        return;
      }
      window.__mbMapPending.push(callback);
      if (window.__mbMapLeafletLoading) {
        return;
      }
      window.__mbMapLeafletLoading = true;
      if (!document.querySelector('link[data-mb-map-leaflet="css"]')) {
        function loadLeafletStylesheet(href, integrity, onFailure) {
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = href;
          if (integrity) {
            link.integrity = integrity;
          }
          link.crossOrigin = 'anonymous';
          link.dataset.mbMapLeaflet = 'css';
          link.onload = function() {
            window.__mbMapLeafletStyleFailed = false;
          };
          link.onerror = function() {
            link.remove();
            if (typeof onFailure === 'function') {
              onFailure();
            } else {
              window.__mbMapLeafletStyleFailed = true;
            }
          };
          document.head.appendChild(link);
        }

        loadLeafletStylesheet(
          'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
          'sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w==',
          function() {
            loadLeafletStylesheet('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css');
          }
        );
      }
      if (!document.querySelector('script[data-mb-map-leaflet="js"]')) {
        function loadLeafletScript(src, integrity, onFailure) {
          const script = document.createElement('script');
          script.src = src;
          if (integrity) {
            script.integrity = integrity;
          }
          script.crossOrigin = 'anonymous';
          script.dataset.mbMapLeaflet = 'js';
          script.onload = function() {
            window.__mbMapLeafletLoading = false;
            window.__mbMapLeafletFailed = false;
            const callbacks = window.__mbMapPending.splice(0);
            callbacks.forEach(function(fn) { fn(); });
          };
          script.onerror = function() {
            script.remove();
            if (typeof onFailure === 'function') {
              onFailure();
            } else {
              window.__mbMapLeafletLoading = false;
              window.__mbMapLeafletFailed = true;
              const callbacks = window.__mbMapPending.splice(0);
              callbacks.forEach(function(fn) { fn(); });
            }
          };
          document.body.appendChild(script);
        }

        loadLeafletScript(
          'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
          'sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg==',
          function() {
            loadLeafletScript('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js');
          }
        );
      }
    };
  }

  if (!window.__mbMapInitMaps) {
    var GEO_CACHE_PREFIX = 'mbMapGeocode:';
    var GEO_CACHE_MAX_AGE = 14 * 24 * 60 * 60 * 1000; // 14 days
    var NOMINATIM_ENDPOINT = 'https://nominatim.openstreetmap.org/search';
    var NOMINATIM_DEFAULT_PARAMS = 'format=jsonv2&limit=1';
    var NOMINATIM_USER_AGENT = 'mbplugin-map/4.2 (+https://github.com/zerok/mbplugin-maps)';
    var NOMINATIM_CONTACT = 'https://github.com/zerok/mbplugin-maps';
    var NOMINATIM_BACKOFF_MS = 1100;
    var lastNominatimRequestTime = 0;

    function detectPreferredColorScheme() {
      var root = document.documentElement || null;
      var body = document.body || null;

      function inspectElement(element) {
        if (!element) {
          return '';
        }

        var dataset = element.dataset || {};
        var candidates = [
          dataset.mbColorScheme,
          dataset.colorScheme,
          dataset.scheme,
          dataset.theme,
          element.getAttribute ? element.getAttribute('data-color-scheme') : null,
          element.getAttribute ? element.getAttribute('data-scheme') : null,
          element.getAttribute ? element.getAttribute('data-theme') : null,
          typeof element.className === 'string' ? element.className : null
        ];

        for (var i = 0; i < candidates.length; i += 1) {
          var value = candidates[i];
          if (!value || typeof value !== 'string') {
            continue;
          }
          var lower = value.toLowerCase();
          if (lower.indexOf('dark') !== -1) {
            return 'dark';
          }
          if (lower.indexOf('light') !== -1) {
            return 'light';
          }
        }

        if (element.classList) {
          if (element.classList.contains('dark')) {
            return 'dark';
          }
          if (element.classList.contains('light')) {
            return 'light';
          }
        }

        return '';
      }

      var fromRoot = inspectElement(root);
      if (fromRoot) {
        return fromRoot;
      }

      var fromBody = inspectElement(body);
      if (fromBody) {
        return fromBody;
      }

      if (window.matchMedia) {
        try {
          if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
          }
          if (window.matchMedia('(prefers-color-scheme: light)').matches) {
            return 'light';
          }
        } catch (mediaError) {
          // Ignore media query errors
        }
      }

      return 'unknown';
    }

    function resolvePreviewStyle(wrapper) {
      if (!wrapper || !wrapper.dataset) {
        return '';
      }

      var defaultStyle = (wrapper.dataset.previewStyle || '').trim();
      var lightStyle = (wrapper.dataset.previewStyleLight || '').trim();
      var darkStyle = (wrapper.dataset.previewStyleDark || '').trim();
      var scheme = detectPreferredColorScheme();

      if (scheme === 'dark') {
        return darkStyle || defaultStyle || lightStyle || '';
      }

      if (scheme === 'light') {
        return lightStyle || defaultStyle || darkStyle || '';
      }

      return defaultStyle || lightStyle || darkStyle || '';
    }

    function clearStaticPreviewFallback(canvas) {
      if (!canvas) {
        return;
      }
      canvas.classList.remove('mb-map-canvas--fallback');
      var fallbackText = canvas.querySelector('.mb-map-preview-fallback-text');
      if (fallbackText) {
        fallbackText.remove();
      }
    }

    function notifyColorSchemeChange() {
      var wrappers = document.querySelectorAll('.mb-map-wrapper');
      wrappers.forEach(function(wrapper) {
        if (!wrapper || wrapper.dataset.mapLoaded === 'true') {
          return;
        }
        if (typeof wrapper.__mbMapUpdatePreview === 'function') {
          try {
            wrapper.__mbMapUpdatePreview();
          } catch (updateError) {
            // Ignore preview update errors to avoid breaking other handlers
          }
        }
      });
    }

    function ensureColorSchemeListeners() {
      if (window.__mbMapColorSchemeListenersInitialized) {
        return;
      }
      window.__mbMapColorSchemeListenersInitialized = true;

      function handleSchemeChange() {
        notifyColorSchemeChange();
      }

      if (window.matchMedia) {
        try {
          var mediaDark = window.matchMedia('(prefers-color-scheme: dark)');
          if (mediaDark) {
            if (typeof mediaDark.addEventListener === 'function') {
              mediaDark.addEventListener('change', handleSchemeChange);
            } else if (typeof mediaDark.addListener === 'function') {
              mediaDark.addListener(handleSchemeChange);
            }
          }

          var mediaLight = window.matchMedia('(prefers-color-scheme: light)');
          if (mediaLight) {
            if (typeof mediaLight.addEventListener === 'function') {
              mediaLight.addEventListener('change', handleSchemeChange);
            } else if (typeof mediaLight.addListener === 'function') {
              mediaLight.addListener(handleSchemeChange);
            }
          }
        } catch (listenerError) {
          // Ignore media query listener errors
        }
      }

      if (window.MutationObserver && document.documentElement) {
        try {
          var observer = new MutationObserver(handleSchemeChange);
          observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ['class', 'data-theme', 'data-color-scheme', 'data-scheme']
          });
          window.__mbMapColorSchemeMutationObserver = observer;
        } catch (observerError) {
          // Ignore mutation observer errors
        }
      }

      if (window.MutationObserver && document.body) {
        try {
          var bodyObserver = new MutationObserver(handleSchemeChange);
          bodyObserver.observe(document.body, {
            attributes: true,
            attributeFilter: ['class', 'data-theme', 'data-color-scheme', 'data-scheme']
          });
          window.__mbMapColorSchemeBodyObserver = bodyObserver;
        } catch (bodyObserverError) {
          // Ignore mutation observer errors on body
        }
      }

      var schemeEvents = ['mb-color-scheme-change', 'themechange', 'color-scheme-change'];
      schemeEvents.forEach(function(eventName) {
        try {
          document.addEventListener(eventName, handleSchemeChange);
        } catch (docListenerError) {
          // Ignore addEventListener errors on document
        }
        try {
          window.addEventListener(eventName, handleSchemeChange);
        } catch (winListenerError) {
          // Ignore addEventListener errors on window
        }
      });

      try {
        var resizeDebounce = null;
        window.addEventListener('resize', function() {
          if (resizeDebounce) {
            clearTimeout(resizeDebounce);
          }
          resizeDebounce = setTimeout(function() {
            resizeDebounce = null;
            notifyColorSchemeChange();
          }, 150);
        }, { passive: true });
      } catch (resizeListenerError) {
        // Ignore resize listener errors
      }
    }

    function buildNominatimUrl(query) {
      var contactParam = NOMINATIM_CONTACT ? '&email=' + encodeURIComponent(NOMINATIM_CONTACT) : '';
      var userAgentParam = NOMINATIM_USER_AGENT ? '&useragent=' + encodeURIComponent(NOMINATIM_USER_AGENT) : '';
      return (
        NOMINATIM_ENDPOINT +
        '?' +
        NOMINATIM_DEFAULT_PARAMS +
        '&q=' + encodeURIComponent(query || '') +
        contactParam +
        userAgentParam
      );
    }

    function createNominatimHeaders() {
      var acceptLanguage = (typeof navigator !== 'undefined' && navigator && navigator.language) ? navigator.language : 'en';
      if (typeof Headers === 'function') {
        try {
          var headerMap = new Headers();
          headerMap.set('Accept-Language', acceptLanguage);
          if (NOMINATIM_CONTACT) {
            headerMap.set('X-Contact-Info', NOMINATIM_CONTACT);
          }
          if (NOMINATIM_USER_AGENT) {
            try {
              headerMap.set('User-Agent', NOMINATIM_USER_AGENT);
            } catch (forbiddenHeaderError) {
              headerMap.set('X-User-Agent', NOMINATIM_USER_AGENT);
            }
          }
          return headerMap;
        } catch (headerError) {
          // Fallback to simple object below
        }
      }

      var fallbackHeaders = { 'Accept-Language': acceptLanguage };
      if (NOMINATIM_CONTACT) {
        fallbackHeaders['X-Contact-Info'] = NOMINATIM_CONTACT;
      }
      if (NOMINATIM_USER_AGENT) {
        fallbackHeaders['X-User-Agent'] = NOMINATIM_USER_AGENT;
      }
      return fallbackHeaders;
    }

    function buildNominatimRequestOptions() {
      var options = {
        method: 'GET',
        headers: createNominatimHeaders(),
        credentials: 'omit',
        cache: 'no-store'
      };

      try {
        options.referrerPolicy = 'no-referrer';
      } catch (policyError) {
        // Older browsers might not support setting referrerPolicy
      }

      return options;
    }

    function queueNominatimRequest(url, options) {
      var now = Date.now ? Date.now() : new Date().getTime();
      var waitTime = 0;
      if (lastNominatimRequestTime) {
        var elapsed = now - lastNominatimRequestTime;
        if (elapsed < NOMINATIM_BACKOFF_MS) {
          waitTime = NOMINATIM_BACKOFF_MS - elapsed;
        }
      }

      function performFetch() {
        lastNominatimRequestTime = Date.now ? Date.now() : new Date().getTime();
        return fetch(url, options);
      }

      if (waitTime <= 0) {
        return performFetch();
      }

      return new Promise(function(resolve) {
        setTimeout(resolve, waitTime);
      }).then(performFetch);
    }

    function supportsSessionStorage() {
      if (typeof supportsSessionStorage.cached === 'boolean') {
        return supportsSessionStorage.cached;
      }
      try {
        var testKey = '__mbMapTest__';
        window.sessionStorage.setItem(testKey, '1');
        window.sessionStorage.removeItem(testKey);
        supportsSessionStorage.cached = true;
      } catch (error) {
        supportsSessionStorage.cached = false;
      }
      return supportsSessionStorage.cached;
    }

    function getCachedCoordinates(query) {
      if (!query || !supportsSessionStorage()) {
        return null;
      }
      var cacheKey = GEO_CACHE_PREFIX + query;
      try {
        var raw = window.sessionStorage.getItem(cacheKey);
        if (!raw) {
          return null;
        }
        var parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') {
          window.sessionStorage.removeItem(cacheKey);
          return null;
        }
        if (typeof parsed.timestamp !== 'number' || (Date.now() - parsed.timestamp) > GEO_CACHE_MAX_AGE) {
          window.sessionStorage.removeItem(cacheKey);
          return null;
        }
        if (!isFinite(parsed.lat) || !isFinite(parsed.lng)) {
          window.sessionStorage.removeItem(cacheKey);
          return null;
        }
        return { lat: parsed.lat, lng: parsed.lng };
      } catch (error) {
        try {
          window.sessionStorage.removeItem(cacheKey);
        } catch (cleanupError) {
          // Ignore cleanup errors
        }
        return null;
      }
    }

    function setCachedCoordinates(query, coords) {
      if (!query || !supportsSessionStorage()) {
        return;
      }
      if (!coords || !isFinite(coords.lat) || !isFinite(coords.lng)) {
        return;
      }
      var cacheKey = GEO_CACHE_PREFIX + query;
      try {
        window.sessionStorage.setItem(cacheKey, JSON.stringify({
          lat: coords.lat,
          lng: coords.lng,
          timestamp: Date.now()
        }));
      } catch (error) {
        try {
          window.sessionStorage.removeItem(cacheKey);
        } catch (cleanupError) {
          // Ignore cleanup errors
        }
      }
    }

    function parseCoordinates(value) {
      if (!value) {
        return null;
      }
      const parts = value.split(',').map(function(part) {
        return part.trim();
      });
      if (parts.length !== 2) {
        return null;
      }
      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      if (!isFinite(lat) || !isFinite(lng)) {
        return null;
      }
      return { lat: lat, lng: lng };
    }

    function createMap(wrapper, lat, lng, zoom, markerText) {
      const mapId = wrapper.dataset.mapId;
      const canvas = document.getElementById(mapId);
      if (!canvas) {
        return;
      }
      canvas.classList.remove('mb-map-canvas--preview');
      canvas.classList.remove('mb-map-canvas--fallback');
      canvas.classList.remove('mb-map-canvas--loading');
      canvas.style.backgroundImage = '';
      canvas.innerHTML = '';
      const map = L.map(mapId, {
        attributionControl: true,
        zoomControl: true,
      }).setView([lat, lng], zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      const marker = L.marker([lat, lng]).addTo(map);
      const cleanedMarkerText = typeof markerText === 'string' ? markerText.trim() : '';
      if (cleanedMarkerText) {
        marker.bindPopup(cleanedMarkerText).openPopup();
      }
      setTimeout(function() {
        map.invalidateSize();
        map.setView([lat, lng], zoom);
      }, 0);
    }

    function clampZoom(zoom) {
      return Math.max(0, Math.min(zoom, 19));
    }

    function buildGeoapifyStaticMapUrl(style, apiKey, lat, lng, zoom, dimensions) {
      const clampedZoom = clampZoom(zoom);
      const formattedLat = lat.toFixed(6);
      const formattedLng = lng.toFixed(6);
      const width = Math.max(1, Math.round(dimensions && dimensions.width ? dimensions.width : 600));
      const height = Math.max(1, Math.round(dimensions && dimensions.height ? dimensions.height : 338));
      const normalizedStyle = (style || '').toString().trim();
      const normalizedKey = (apiKey || '').toString().trim();

      if (!normalizedKey) {
        return null;
      }

      const styleName = normalizedStyle || 'osm-carto';
      const markerColor = '%23dd2e44';
      return 'https://maps.geoapify.com/v1/staticmap?style=' + encodeURIComponent(styleName) +
        '&width=' + width + '&height=' + height +
        '&center=lonlat:' + encodeURIComponent(formattedLng + ',' + formattedLat) +
        '&zoom=' + clampedZoom +
        '&marker=lonlat:' + encodeURIComponent(formattedLng + ',' + formattedLat) +
        ';type:awesome;color:' + markerColor + ';size:medium&apiKey=' + encodeURIComponent(normalizedKey);
    }

    function buildStaticMapUrl(wrapper, lat, lng, zoom, dimensions) {
      if (!wrapper || !wrapper.dataset) {
        return null;
      }
      const apiKey = (wrapper.dataset.previewKey || '').trim();
      const style = resolvePreviewStyle(wrapper);
      if (style) {
        wrapper.dataset.activePreviewStyle = style;
      } else {
        delete wrapper.dataset.activePreviewStyle;
      }
      return buildGeoapifyStaticMapUrl(style, apiKey, lat, lng, zoom, dimensions);
    }

    function showStaticPreviewUnavailable(canvas, message) {
      canvas.classList.add('mb-map-canvas--fallback');
      const existingMessage = canvas.querySelector('.mb-map-preview-fallback-text');
      if (!existingMessage) {
        const info = document.createElement('p');
        info.className = 'mb-map-preview-fallback-text';
        info.textContent = message || 'Static map preview is currently unavailable.';
        canvas.insertBefore(info, canvas.firstChild || null);
      }
    }

    function calculatePreviewDimensions(canvas) {
      const fallback = { width: 600, height: 338 };
      if (!canvas) {
        return fallback;
      }

      let rect = null;
      try {
        rect = typeof canvas.getBoundingClientRect === 'function' ? canvas.getBoundingClientRect() : null;
      } catch (rectError) {
        rect = null;
      }

      const rawPixelRatio = (typeof window !== 'undefined' && window && window.devicePixelRatio) ? window.devicePixelRatio : 1;
      const devicePixelRatio = rawPixelRatio > 0 ? rawPixelRatio : 1;
      const width = rect && rect.width ? rect.width : (canvas.clientWidth || 0);
      const height = rect && rect.height ? rect.height : (canvas.clientHeight || 0);

      if (!(width > 0) || !(height > 0)) {
        return fallback;
      }

      const scaledWidth = Math.max(1, Math.round(width * devicePixelRatio));
      const scaledHeight = Math.max(1, Math.round(height * devicePixelRatio));
      const MAX_DIMENSION = 2048;
      const scaleFactor = Math.min(1, MAX_DIMENSION / scaledWidth, MAX_DIMENSION / scaledHeight);

      if (scaleFactor < 1) {
        return {
          width: Math.max(1, Math.round(scaledWidth * scaleFactor)),
          height: Math.max(1, Math.round(scaledHeight * scaleFactor))
        };
      }

      return { width: scaledWidth, height: scaledHeight };
    }

    function showPreview(wrapper, lat, lng, zoom, markerText, locationLabel) {
      const mapId = wrapper.dataset.mapId;
      const canvas = document.getElementById(mapId);
      if (!canvas) {
        return;
      }
      canvas.innerHTML = '';
      canvas.classList.add('mb-map-canvas--preview');
      canvas.classList.remove('mb-map-canvas--fallback');

      const descriptiveLabel = locationLabel && locationLabel.trim() ? locationLabel.trim() : 'map location';
      const trimmedMarkerText = typeof markerText === 'string' ? markerText.trim() : '';
      const previewKey = (wrapper.dataset.previewKey || '').trim();
      if (!previewKey) {
        showStaticPreviewUnavailable(canvas, 'Static map preview requires a Geoapify API key.');
        return;
      }

      const img = document.createElement('img');
      img.className = 'mb-map-preview-image';
      img.decoding = 'async';
      img.loading = 'lazy';
      img.referrerPolicy = 'no-referrer';
      img.alt = 'Static map preview for ' + descriptiveLabel + '.';

      function handlePreviewError() {
        img.remove();
        showStaticPreviewUnavailable(canvas);
      }

      img.addEventListener('error', handlePreviewError);

      const controls = document.createElement('div');
      controls.className = 'mb-map-preview-controls';

      if (trimmedMarkerText) {
        const caption = document.createElement('p');
        caption.className = 'mb-map-preview-caption';
        caption.textContent = trimmedMarkerText;
        controls.appendChild(caption);
      }

      function updatePreviewImage() {
        const dimensions = calculatePreviewDimensions(canvas);
        const staticMapUrl = buildStaticMapUrl(wrapper, lat, lng, zoom, dimensions);
        if (!staticMapUrl) {
          if (img.parentNode) {
            img.remove();
          }
          showStaticPreviewUnavailable(canvas);
          return false;
        }
        clearStaticPreviewFallback(canvas);
        if (img.parentNode !== canvas) {
          canvas.insertBefore(img, canvas.firstChild || null);
        }
        if (img.dataset.mbMapUrl !== staticMapUrl) {
          img.dataset.mbMapUrl = staticMapUrl;
          img.src = staticMapUrl;
        }
        img.dataset.mbMapStyle = wrapper.dataset.activePreviewStyle || '';
        return true;
      }

      wrapper.__mbMapUpdatePreview = updatePreviewImage;
      const previewAvailable = updatePreviewImage();
      if (!previewAvailable) {
        delete wrapper.__mbMapUpdatePreview;
        return;
      }

      if (controls.childElementCount > 0) {
        canvas.appendChild(controls);
      }

      const markerDescription = trimmedMarkerText ? '. Marker: ' + trimmedMarkerText : '';
      const accessibleLabel = 'Load interactive map for ' + descriptiveLabel + markerDescription;
      canvas.setAttribute('role', 'button');
      canvas.setAttribute('tabindex', '0');
      canvas.setAttribute('aria-label', accessibleLabel);

      function cleanupPreviewInteractions() {
        canvas.removeEventListener('click', handlePreviewClick);
        canvas.removeEventListener('keydown', handlePreviewKeydown);
        canvas.removeAttribute('role');
        canvas.removeAttribute('tabindex');
        canvas.removeAttribute('aria-label');
        canvas.removeAttribute('aria-busy');
        delete wrapper.dataset.activePreviewStyle;
        delete wrapper.__mbMapUpdatePreview;
      }

      function handlePreviewClick(event) {
        event.preventDefault();
        if (wrapper.dataset.mapLoaded === 'true' || wrapper.dataset.mapLoading === 'true') {
          return;
        }
        wrapper.dataset.mapLoading = 'true';
        canvas.setAttribute('aria-busy', 'true');
        if (!canvas.classList.contains('mb-map-canvas--preview')) {
          canvas.textContent = '';
        }
        const loadingText = document.createElement('div');
        loadingText.className = 'mb-map-loading-text';
        loadingText.textContent = 'Loading map…';
        canvas.appendChild(loadingText);

        window.__mbMapEnsureLeaflet(function() {
          canvas.removeAttribute('aria-busy');
          delete wrapper.dataset.mapLoading;
          if (!window.L || !window.L.map) {
            if (loadingText.parentNode) {
              loadingText.remove();
            }
            showError(wrapper, 'Leaflet could not be loaded.');
            return;
          }
          cleanupPreviewInteractions();
          createMap(wrapper, lat, lng, zoom, markerText);
          wrapper.dataset.mapLoaded = 'true';
        });
      }

      function handlePreviewKeydown(event) {
        if (event.key === 'Enter' || event.key === ' ' || event.key === 'Spacebar') {
          event.preventDefault();
          handlePreviewClick(event);
        }
      }

      canvas.addEventListener('click', handlePreviewClick);
      canvas.addEventListener('keydown', handlePreviewKeydown);

      ensureColorSchemeListeners();
    }

    function showError(wrapper, message) {
      const mapId = wrapper.dataset.mapId;
      const canvas = document.getElementById(mapId);
      if (canvas) {
        canvas.classList.remove('mb-map-canvas--preview');
        canvas.classList.remove('mb-map-canvas--fallback');
        canvas.classList.remove('mb-map-canvas--loading');
        canvas.style.backgroundImage = '';
        canvas.removeAttribute('role');
        canvas.removeAttribute('tabindex');
        canvas.removeAttribute('aria-label');
        canvas.removeAttribute('aria-busy');
        canvas.textContent = message;
      }
    }

    window.__mbMapInitMaps = function() {
      const wrappers = document.querySelectorAll('.mb-map-wrapper');
      wrappers.forEach(function(wrapper) {
        if (wrapper.dataset.initialized === 'true') {
          return;
        }

        wrapper.dataset.initialized = 'true';
        const zoomValue = parseInt(wrapper.dataset.zoom, 10);
        const zoom = Number.isFinite(zoomValue) ? zoomValue : 14;
        const locationValue = wrapper.dataset.loc;
        const markerText = wrapper.dataset.marker ? wrapper.dataset.marker.trim() : '';
        const normalizedLocation = locationValue ? locationValue.trim().toLowerCase() : '';
        const coords = parseCoordinates(locationValue);

        if (coords) {
          showPreview(wrapper, coords.lat, coords.lng, zoom, markerText, locationValue);
          return;
        }

        const mapId = wrapper.dataset.mapId;
        const canvas = document.getElementById(mapId);
        if (canvas) {
          canvas.textContent = 'Searching for location…';
        }

        const cached = normalizedLocation ? getCachedCoordinates(normalizedLocation) : null;
        if (cached) {
          showPreview(wrapper, cached.lat, cached.lng, zoom, markerText, locationValue);
          return;
        }

        const requestUrl = buildNominatimUrl(locationValue);
        const requestOptions = buildNominatimRequestOptions();
        queueNominatimRequest(requestUrl, requestOptions)
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(function(results) {
            if (!Array.isArray(results) || results.length === 0) {
              showError(wrapper, 'Location not found.');
              return;
            }
            const result = results[0];
            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);
            if (!isFinite(lat) || !isFinite(lng)) {
              showError(wrapper, 'Location not found.');
              return;
            }
            if (normalizedLocation) {
              setCachedCoordinates(normalizedLocation, { lat: lat, lng: lng });
            }
            showPreview(wrapper, lat, lng, zoom, markerText, locationValue);
          })
          .catch(function() {
            showError(wrapper, 'Unable to load the map right now.');
          });
      });
    };
  }

  window.__mbMapInitMaps();
})();
</script>
{{ end }}

{{ $loc := .Get "loc" }}
{{ if not $loc }}
<p class="mb-map-error">No location provided for map shortcode.</p>
{{ else }}
{{ $zoom := .Get "zoom" | default .Site.Params.default_map_zoom | default "14" }}
{{ $marker := .Get "marker" | default "" }}
{{ $id := printf "mb-map-%d" (now.UnixNano) }}
{{ $previewStyle := .Site.Params.map_preview_style | default "" }}
{{ $previewApiKey := .Site.Params.map_preview_api_key | default "" }}
{{ $buttonText := .Site.Params.map_load_button_text | default "Show interactive map" }}
{{ if not (.Page.Scratch.Get "mb-map-style-loaded") }}
{{ .Page.Scratch.Set "mb-map-style-loaded" true }}
<style>
.mb-map-wrapper {
  position: relative;
  padding-bottom: 56.25%;
  height: 0;
  overflow: hidden;
  background-color: #eef2f4;
  max-width: 100%;
  border-radius: 8px;
}
.mb-map-canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  color: #1b1b1b;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 1rem;
}
.mb-map-canvas--preview {
  flex-direction: column;
  gap: 1rem;
}
.mb-map-canvas--fallback {
  background: repeating-linear-gradient(
      45deg,
      rgba(27, 27, 27, 0.08) 0,
      rgba(27, 27, 27, 0.08) 12px,
      rgba(27, 27, 27, 0.14) 12px,
      rgba(27, 27, 27, 0.14) 24px
    )
    #eef2f4;
}
.mb-map-preview-image {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}
.mb-map-preview-fallback-text {
  margin: 0 0 0.75rem;
  padding: 0.75rem 1rem;
  font-size: 0.95rem;
  font-weight: 500;
  color: #1f2937;
  text-align: center;
  background: rgba(255, 255, 255, 0.85);
  border-radius: 8px;
  box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
}
.mb-map-preview-controls {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  margin-top: clamp(3.5rem, 24vh, 11rem);
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.65);
}
.mb-map-canvas--fallback .mb-map-preview-controls {
  color: #1f2937;
  text-shadow: none;
}
.mb-map-canvas--fallback .mb-map-preview-controls p {
  color: inherit;
}
.mb-map-load-button {
  background-color: #1b1b1b;
  color: #fff;
  border: none;
  border-radius: 999px;
  font-weight: 600;
  padding: 0.65rem 1.25rem;
  cursor: pointer;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
  transition: transform 0.15s ease, box-shadow 0.15s ease, background-color 0.2s ease;
}
.mb-map-load-button:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 14px 36px rgba(0, 0, 0, 0.22);
}
.mb-map-load-button:focus-visible {
  outline: 3px solid rgba(30, 64, 175, 0.45);
  outline-offset: 3px;
}
.mb-map-load-button:disabled {
  opacity: 0.75;
  cursor: wait;
}
.mb-map-wrapper .leaflet-container {
  width: 100%;
  height: 100%;
}
.mb-map-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background: rgba(0, 0, 0, 0.65);
  color: #fff;
  text-align: center;
  font-size: 0.85em;
  padding: 0.5em 1em;
  z-index: 5;
  pointer-events: none;
}
.mb-map-error {
  margin: 1rem 0;
  padding: 0.75rem 1rem;
  border-radius: 6px;
  background: #fee2e2;
  color: #991b1b;
}
</style>
{{ end }}
<div class="mb-map-wrapper" data-mb-map="true" data-map-id="{{ $id }}" data-loc="{{ $loc | htmlEscape }}" data-zoom="{{ $zoom }}" data-marker="{{ $marker | htmlEscape }}" data-preview-style="{{ $previewStyle | htmlEscape }}" data-preview-key="{{ $previewApiKey | htmlEscape }}" data-button-text="{{ $buttonText | htmlEscape }}">
  <div id="{{ $id }}" class="mb-map-canvas">Loading map…</div>
  {{ if .Site.Params.show_privacy_notice }}
    {{ $privacyText := or .Site.Params.map_privacy_notice_text .Site.Params.googlemaps_privacy_notice_text }}
    <div class="mb-map-overlay">
      {{ with $privacyText }}
        {{ . }}
      {{ else }}
        Map data © OpenStreetMap contributors.
      {{ end }}
    </div>
  {{ end }}
</div>
<noscript>
  <p class="mb-map-error">Maps require JavaScript to display.</p>
</noscript>
<script>
(function() {
  if (!window.__mbMapEnsureLeaflet) {
    window.__mbMapPending = [];
    window.__mbMapEnsureLeaflet = function(callback) {
      if (window.__mbMapLeafletFailed) {
        callback();
        return;
      }
      if (window.L && window.L.map) {
        callback();
        return;
      }
      window.__mbMapPending.push(callback);
      if (window.__mbMapLeafletLoading) {
        return;
      }
      window.__mbMapLeafletLoading = true;
      if (!document.querySelector('link[data-mb-map-leaflet="css"]')) {
        function loadLeafletStylesheet(href, integrity, onFailure) {
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = href;
          if (integrity) {
            link.integrity = integrity;
          }
          link.crossOrigin = 'anonymous';
          link.dataset.mbMapLeaflet = 'css';
          link.onload = function() {
            window.__mbMapLeafletStyleFailed = false;
          };
          link.onerror = function() {
            link.remove();
            if (typeof onFailure === 'function') {
              onFailure();
            } else {
              window.__mbMapLeafletStyleFailed = true;
            }
          };
          document.head.appendChild(link);
        }

        loadLeafletStylesheet(
          'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
          'sha512-sA+e2pMvU0N2sfx8bV+RaH59RUW2KIiMzH6I0X58F3RrgPf63eNbUsMUKc7kwh28ykV59C1yH3e1h52mS7P4hQ==',
          function() {
            loadLeafletStylesheet('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css');
          }
        );
      }
      if (!document.querySelector('script[data-mb-map-leaflet="js"]')) {
        function loadLeafletScript(src, integrity, onFailure) {
          const script = document.createElement('script');
          script.src = src;
          if (integrity) {
            script.integrity = integrity;
          }
          script.crossOrigin = 'anonymous';
          script.dataset.mbMapLeaflet = 'js';
          script.onload = function() {
            window.__mbMapLeafletLoading = false;
            window.__mbMapLeafletFailed = false;
            const callbacks = window.__mbMapPending.splice(0);
            callbacks.forEach(function(fn) { fn(); });
          };
          script.onerror = function() {
            script.remove();
            if (typeof onFailure === 'function') {
              onFailure();
            } else {
              window.__mbMapLeafletLoading = false;
              window.__mbMapLeafletFailed = true;
              const callbacks = window.__mbMapPending.splice(0);
              callbacks.forEach(function(fn) { fn(); });
            }
          };
          document.body.appendChild(script);
        }

        loadLeafletScript(
          'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
          'sha512-vJ0wZgfGQm6G3y9kA0RduCMJLZ/HdlIQK5vCk1vZ1tcHTTX3e8DqRLVQjaxAgAnszCQQXTsQJ4nxs1jGME4pKw==',
          function() {
            loadLeafletScript('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js');
          }
        );
      }
    };
  }

  if (!window.__mbMapInitMaps) {
    var GEO_CACHE_PREFIX = 'mbMapGeocode:';
    var GEO_CACHE_MAX_AGE = 14 * 24 * 60 * 60 * 1000; // 14 days

    function supportsSessionStorage() {
      if (typeof supportsSessionStorage.cached === 'boolean') {
        return supportsSessionStorage.cached;
      }
      try {
        var testKey = '__mbMapTest__';
        window.sessionStorage.setItem(testKey, '1');
        window.sessionStorage.removeItem(testKey);
        supportsSessionStorage.cached = true;
      } catch (error) {
        supportsSessionStorage.cached = false;
      }
      return supportsSessionStorage.cached;
    }

    function getCachedCoordinates(query) {
      if (!query || !supportsSessionStorage()) {
        return null;
      }
      var cacheKey = GEO_CACHE_PREFIX + query;
      try {
        var raw = window.sessionStorage.getItem(cacheKey);
        if (!raw) {
          return null;
        }
        var parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== 'object') {
          window.sessionStorage.removeItem(cacheKey);
          return null;
        }
        if (typeof parsed.timestamp !== 'number' || (Date.now() - parsed.timestamp) > GEO_CACHE_MAX_AGE) {
          window.sessionStorage.removeItem(cacheKey);
          return null;
        }
        if (!isFinite(parsed.lat) || !isFinite(parsed.lng)) {
          window.sessionStorage.removeItem(cacheKey);
          return null;
        }
        return { lat: parsed.lat, lng: parsed.lng };
      } catch (error) {
        try {
          window.sessionStorage.removeItem(cacheKey);
        } catch (cleanupError) {
          // Ignore cleanup errors
        }
        return null;
      }
    }

    function setCachedCoordinates(query, coords) {
      if (!query || !supportsSessionStorage()) {
        return;
      }
      if (!coords || !isFinite(coords.lat) || !isFinite(coords.lng)) {
        return;
      }
      var cacheKey = GEO_CACHE_PREFIX + query;
      try {
        window.sessionStorage.setItem(cacheKey, JSON.stringify({
          lat: coords.lat,
          lng: coords.lng,
          timestamp: Date.now()
        }));
      } catch (error) {
        try {
          window.sessionStorage.removeItem(cacheKey);
        } catch (cleanupError) {
          // Ignore cleanup errors
        }
      }
    }

    function parseCoordinates(value) {
      if (!value) {
        return null;
      }
      const parts = value.split(',').map(function(part) {
        return part.trim();
      });
      if (parts.length !== 2) {
        return null;
      }
      const lat = parseFloat(parts[0]);
      const lng = parseFloat(parts[1]);
      if (!isFinite(lat) || !isFinite(lng)) {
        return null;
      }
      return { lat: lat, lng: lng };
    }

    function createMap(wrapper, lat, lng, zoom, markerText) {
      const mapId = wrapper.dataset.mapId;
      const canvas = document.getElementById(mapId);
      if (!canvas) {
        return;
      }
      canvas.classList.remove('mb-map-canvas--preview');
      canvas.classList.remove('mb-map-canvas--fallback');
      canvas.style.backgroundImage = '';
      canvas.innerHTML = '';
      const map = L.map(mapId, {
        attributionControl: true,
        zoomControl: true,
      }).setView([lat, lng], zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      const marker = L.marker([lat, lng]).addTo(map);
      if (markerText && markerText.trim()) {
        marker.bindPopup(markerText).openPopup();
      }
    }

    function clampZoom(zoom) {
      return Math.max(0, Math.min(zoom, 19));
    }

    function buildGeoapifyStaticMapUrl(style, apiKey, lat, lng, zoom) {
      const clampedZoom = clampZoom(zoom);
      const formattedLat = lat.toFixed(6);
      const formattedLng = lng.toFixed(6);
      const width = 600;
      const height = 338;
      const normalizedStyle = (style || '').toString().trim();
      const normalizedKey = (apiKey || '').toString().trim();

      if (!normalizedKey) {
        return null;
      }

      const styleName = normalizedStyle || 'osm-carto';
      const markerColor = '%23dd2e44';
      return 'https://maps.geoapify.com/v1/staticmap?style=' + encodeURIComponent(styleName) +
        '&width=' + width + '&height=' + height +
        '&center=lonlat:' + encodeURIComponent(formattedLng + ',' + formattedLat) +
        '&zoom=' + clampedZoom +
        '&marker=lonlat:' + encodeURIComponent(formattedLng + ',' + formattedLat) +
        ';type:awesome;color:' + markerColor + ';size:medium&apiKey=' + encodeURIComponent(normalizedKey);
    }

    function buildStaticMapUrl(wrapper, lat, lng, zoom) {
      const style = wrapper.dataset.previewStyle || '';
      const apiKey = wrapper.dataset.previewKey || '';
      return buildGeoapifyStaticMapUrl(style, apiKey, lat, lng, zoom);
    }

    function showStaticPreviewUnavailable(canvas, message) {
      canvas.classList.add('mb-map-canvas--fallback');
      const existingMessage = canvas.querySelector('.mb-map-preview-fallback-text');
      if (!existingMessage) {
        const info = document.createElement('p');
        info.className = 'mb-map-preview-fallback-text';
        info.textContent = message || 'Static map preview is currently unavailable.';
        canvas.insertBefore(info, canvas.firstChild || null);
      }
    }

    function showPreview(wrapper, lat, lng, zoom, markerText, locationLabel) {
      const mapId = wrapper.dataset.mapId;
      const canvas = document.getElementById(mapId);
      if (!canvas) {
        return;
      }
      canvas.innerHTML = '';
      canvas.classList.add('mb-map-canvas--preview');
      canvas.classList.remove('mb-map-canvas--fallback');

      const existingImage = canvas.querySelector('img.mb-map-preview-image');
      if (existingImage) {
        existingImage.remove();
      }

      const descriptiveLabel = locationLabel && locationLabel.trim() ? locationLabel.trim() : 'map location';
      const previewKey = (wrapper.dataset.previewKey || '').trim();
      if (!previewKey) {
        showStaticPreviewUnavailable(canvas, 'Static map preview requires a Geoapify API key.');
        return;
      }

      const staticMapUrl = buildStaticMapUrl(wrapper, lat, lng, zoom);
      const img = document.createElement('img');
      img.className = 'mb-map-preview-image';
      img.decoding = 'async';
      img.loading = 'lazy';
      img.referrerPolicy = 'no-referrer';
      img.alt = 'Static map preview for ' + descriptiveLabel + '.';

      if (staticMapUrl) {
        img.src = staticMapUrl;
      }

      if (staticMapUrl) {
        canvas.appendChild(img);
      }

      if (staticMapUrl) {
        img.addEventListener('error', function handlePreviewError() {
          img.remove();
          showStaticPreviewUnavailable(canvas);
        });
      } else {
        showStaticPreviewUnavailable(canvas);
      }

      const controls = document.createElement('div');
      controls.className = 'mb-map-preview-controls';

      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'mb-map-load-button';
      const buttonLabel = (wrapper.dataset.buttonText || 'Show interactive map').trim() || 'Show interactive map';
      button.textContent = buttonLabel;
      button.addEventListener('click', function(event) {
        event.preventDefault();
        if (button.disabled) {
          return;
        }
        button.disabled = true;
        button.textContent = 'Loading map…';
        window.__mbMapEnsureLeaflet(function() {
          if (!window.L || !window.L.map) {
            showError(wrapper, 'Leaflet could not be loaded.');
            return;
          }
          wrapper.dataset.mapLoaded = 'true';
          createMap(wrapper, lat, lng, zoom, markerText);
        });
      });

      controls.appendChild(button);

      if (markerText && markerText.trim()) {
        const caption = document.createElement('p');
        caption.textContent = markerText.trim();
        controls.appendChild(caption);
      }

      canvas.appendChild(controls);
    }

    function showError(wrapper, message) {
      const mapId = wrapper.dataset.mapId;
      const canvas = document.getElementById(mapId);
      if (canvas) {
        canvas.classList.remove('mb-map-canvas--preview');
        canvas.style.backgroundImage = '';
        canvas.textContent = message;
      }
    }

    window.__mbMapInitMaps = function() {
      const wrappers = document.querySelectorAll('.mb-map-wrapper');
      wrappers.forEach(function(wrapper) {
        if (wrapper.dataset.initialized === 'true') {
          return;
        }

        wrapper.dataset.initialized = 'true';
        const zoomValue = parseInt(wrapper.dataset.zoom, 10);
        const zoom = Number.isFinite(zoomValue) ? zoomValue : 14;
        const locationValue = wrapper.dataset.loc;
        const markerText = wrapper.dataset.marker ? wrapper.dataset.marker.trim() : '';
        const normalizedLocation = locationValue ? locationValue.trim().toLowerCase() : '';
        const coords = parseCoordinates(locationValue);

        if (coords) {
          showPreview(wrapper, coords.lat, coords.lng, zoom, markerText, locationValue);
          return;
        }

        const mapId = wrapper.dataset.mapId;
        const canvas = document.getElementById(mapId);
        if (canvas) {
          canvas.textContent = 'Searching for location…';
        }

        const cached = normalizedLocation ? getCachedCoordinates(normalizedLocation) : null;
        if (cached) {
          showPreview(wrapper, cached.lat, cached.lng, zoom, markerText, locationValue);
          return;
        }

        const url = 'https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q=' + encodeURIComponent(locationValue);
        fetch(url, {
          headers: {
            'Accept-Language': (navigator.language || 'en')
          }
        })
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(function(results) {
            if (!Array.isArray(results) || results.length === 0) {
              showError(wrapper, 'Location not found.');
              return;
            }
            const result = results[0];
            const lat = parseFloat(result.lat);
            const lng = parseFloat(result.lon);
            if (!isFinite(lat) || !isFinite(lng)) {
              showError(wrapper, 'Location not found.');
              return;
            }
            if (normalizedLocation) {
              setCachedCoordinates(normalizedLocation, { lat: lat, lng: lng });
            }
            showPreview(wrapper, lat, lng, zoom, markerText, locationValue);
          })
          .catch(function() {
            showError(wrapper, 'Unable to load the map right now.');
          });
      });
    };
  }

  window.__mbMapInitMaps();
})();
</script>
{{ end }}

<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Micro.blog Maps Validator</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha512-Zcn6bjR/8RZbLEpLIeOwNtzREBAJnUKESxces60Mpoj+2okopSAcSUIUOseddDm0cxnGQzxIR7vJgsLZbdLE3w=="
      crossorigin="anonymous"
    />
    <style>
      :root {
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        color: #0f172a;
        line-height: 1.6;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: #ffffff;
      }

      .page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: clamp(2rem, 4vw, 3rem) clamp(1.5rem, 4vw, 3rem) 1.5rem;
        text-align: left;
        max-width: 1100px;
        margin: 0 auto;
        width: 100%;
      }

      header h1 {
        margin: 0 0 0.75rem;
        font-size: clamp(2rem, 5vw, 3rem);
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      header p {
        margin: 0;
        max-width: 680px;
        color: #475569;
        font-size: 1.05rem;
      }

      main {
        flex: 1;
        width: 100%;
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(280px, 360px) minmax(0, 1fr);
        gap: clamp(1.5rem, 4vw, 3rem);
        align-items: start;
        padding: 0 clamp(1.5rem, 4vw, 3rem) clamp(2.5rem, 6vw, 4rem);
        max-width: 1100px;
        margin: 0 auto;
        box-sizing: border-box;
      }

      .config-panel {
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      form {
        display: grid;
        gap: 1.25rem;
        padding: clamp(1.75rem, 3vw, 2.5rem);
        border: 1px solid #e2e8f0;
        border-radius: 18px;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
        background: #f8fafc;
      }

      form label {
        display: grid;
        gap: 0.4rem;
        font-size: 0.95rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #334155;
      }

      form input,
      form textarea {
        font: inherit;
        padding: 0.65rem 0.75rem;
        border-radius: 10px;
        border: 1px solid #cbd5f5;
        background: #ffffff;
        color: inherit;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        resize: vertical;
      }

      form textarea {
        min-height: 90px;
      }

      form input:focus,
      form textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
      }

      button[type="submit"] {
        justify-self: start;
        padding: 0.75rem 1.75rem;
        border-radius: 999px;
        border: none;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        background: linear-gradient(135deg, #6366f1, #38bdf8);
        color: #ffffff;
        box-shadow: 0 12px 24px rgba(99, 102, 241, 0.25);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      button[type="submit"]:hover {
        transform: translateY(-1px);
        box-shadow: 0 16px 32px rgba(56, 189, 248, 0.25);
      }

      .snippet-card {
        padding: clamp(1.75rem, 3vw, 2.25rem);
        border-radius: 18px;
        border: 1px solid #e2e8f0;
        background: #ffffff;
        box-shadow: 0 12px 32px rgba(15, 23, 42, 0.06);
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .snippet-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .snippet-header h2 {
        margin: 0;
        font-size: 1.05rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        color: #475569;
      }

      #copy-shortcode {
        padding: 0.55rem 1.25rem;
        border-radius: 999px;
        border: none;
        background: #0f172a;
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      #copy-shortcode:hover {
        background: #1e293b;
        transform: translateY(-1px);
      }

      pre {
        margin: 0;
        padding: 1.5rem;
        border-radius: 14px;
        background: #0f172a;
        color: #f8fafc;
        font-size: 1rem;
        overflow-x: auto;
        min-height: 140px;
        display: flex;
        align-items: flex-start;
      }

      pre code {
        font-family: "JetBrains Mono", "Fira Code", "SFMono-Regular", Menlo, Consolas, monospace;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .previews {
        display: flex;
        flex-direction: column;
        gap: clamp(1.5rem, 3vw, 2rem);
      }

      .preview-card {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 18px;
        padding: clamp(1.5rem, 3vw, 2rem);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      }

      .preview-card label {
        display: grid;
        gap: 0.35rem;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #334155;
      }

      .preview-card select {
        font: inherit;
        padding: 0.55rem 0.75rem;
        border-radius: 10px;
        border: 1px solid #cbd5f5;
        background: #ffffff;
        color: inherit;
      }

      .map-frame {
        position: relative;
        width: 100%;
        border-radius: 16px;
        overflow: hidden;
        min-height: 320px;
        background: #e2e8f0;
        aspect-ratio: 16 / 9;
      }

      .leaflet-container {
        width: 100%;
        height: 100%;
      }

      .status-message {
        margin: 0;
        font-size: 0.95rem;
        color: #0f172a;
        min-height: 1.5rem;
      }

      .status-message[data-state="loading"] {
        color: #2563eb;
      }

      .status-message[data-state="error"] {
        color: #dc2626;
      }

      .status-message[data-state="success"] {
        color: #047857;
      }

      @media (max-width: 900px) {
        .layout {
          grid-template-columns: 1fr;
        }

        header {
          text-align: center;
        }

        header p {
          margin-left: auto;
          margin-right: auto;
        }

        .snippet-header {
          flex-direction: column;
          align-items: flex-start;
        }

        #copy-shortcode {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <h1>Micro.blog Maps Validator</h1>
        <p>
          Teste deinen <code>{{&nbsp;map&nbsp;}}</code>-Shortcode live, vergleiche zwei Karten-Styles nebeneinander und kopiere
          den fertigen Code direkt in die Zwischenablage.
        </p>
      </header>
      <main>
        <div class="layout">
          <div class="config-panel">
            <form id="map-config">
              <label>
                Standort / Koordinaten
                <input type="text" name="loc" value="Berlin, Deutschland" placeholder="z. B. 52.5200, 13.4050" required />
              </label>
              <label>
                Zoom-Level (1–18)
                <input type="number" name="zoom" min="1" max="18" value="12" />
              </label>
              <label>
                Marker-Text
                <textarea name="marker" placeholder="Optionale Beschreibung für den Marker">Brandenburger Tor</textarea>
              </label>
              <button type="submit">Vorschau aktualisieren</button>
            </form>

            <div class="snippet-card">
              <div class="snippet-header">
                <h2>Shortcode</h2>
                <button type="button" id="copy-shortcode" aria-live="polite">Copy</button>
              </div>
              <pre><code id="shortcode-output"></code></pre>
              <p class="status-message" id="status-message" role="status"></p>
            </div>
          </div>

          <div class="previews">
            <div class="preview-card">
              <label>
                Preview Style A
                <select id="style-a"></select>
              </label>
              <div class="map-frame" id="map-a"></div>
            </div>
            <div class="preview-card">
              <label>
                Preview Style B
                <select id="style-b"></select>
              </label>
              <div class="map-frame" id="map-b"></div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg=="
      crossorigin="anonymous"
    ></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const styleLibrary = [
          {
            value: 'osm-carto',
            label: 'OSM Carto (Standard)',
            url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
            options: {
              maxZoom: 19,
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> Mitwirkende'
            }
          },
          {
            value: 'carto-light',
            label: 'Carto Light',
            url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
            options: {
              maxZoom: 19,
              subdomains: 'abcd',
              attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> Mitwirkende &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }
          },
          {
            value: 'carto-dark',
            label: 'Carto Dark Matter',
            url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            options: {
              maxZoom: 19,
              subdomains: 'abcd',
              attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> Mitwirkende &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }
          },
          {
            value: 'stamen-terrain',
            label: 'Stamen Terrain',
            url: 'https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg',
            options: {
              maxZoom: 18,
              subdomains: 'abcd',
              attribution:
                'Map tiles by <a href="https://stamen.com">Stamen Design</a>, under <a href="https://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> Mitwirkende'
            }
          },
          {
            value: 'stamen-toner',
            label: 'Stamen Toner',
            url: 'https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png',
            options: {
              maxZoom: 20,
              subdomains: 'abcd',
              attribution:
                'Map tiles by <a href="https://stamen.com">Stamen Design</a>, under <a href="https://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> Mitwirkende'
            }
          }
        ];

        const form = document.getElementById('map-config');
        const shortcodeOutput = document.getElementById('shortcode-output');
        const copyButton = document.getElementById('copy-shortcode');
        const statusMessage = document.getElementById('status-message');
        const styleSelectA = document.getElementById('style-a');
        const styleSelectB = document.getElementById('style-b');

        function populateSelect(select, defaultValue) {
          styleLibrary.forEach(function(style) {
            const option = document.createElement('option');
            option.value = style.value;
            option.textContent = style.label;
            select.appendChild(option);
          });
          select.value = defaultValue;
        }

        populateSelect(styleSelectA, 'osm-carto');
        populateSelect(styleSelectB, 'carto-dark');

        function createPreview(select, containerId) {
          const map = L.map(containerId, { zoomControl: true });
          const preview = {
            map: map,
            select: select,
            currentLayer: null,
            marker: null
          };

          function applyStyle(styleValue) {
            const style = styleLibrary.find(function(item) {
              return item.value === styleValue;
            }) || styleLibrary[0];

            if (preview.currentLayer) {
              preview.map.removeLayer(preview.currentLayer);
            }

            preview.currentLayer = L.tileLayer(style.url, style.options || {});
            preview.currentLayer.addTo(preview.map);
          }

          preview.applyStyle = applyStyle;

          select.addEventListener('change', function() {
            applyStyle(select.value);
          });

          applyStyle(select.value);
          return preview;
        }

        const previewA = createPreview(styleSelectA, 'map-a');
        const previewB = createPreview(styleSelectB, 'map-b');

        function parseCoordinates(value) {
          if (!value) {
            return null;
          }
          const parts = value.split(',');
          if (parts.length !== 2) {
            return null;
          }
          const lat = parseFloat(parts[0]);
          const lng = parseFloat(parts[1]);
          if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
            return null;
          }
          return { lat: lat, lng: lng };
        }

        function updateShortcode() {
          const loc = form.loc.value.trim();
          const zoom = form.zoom.value.trim();
          const marker = form.marker.value.trim();
          let snippet = '{{< map';
          if (loc) {
            snippet += ' loc="' + loc.replace(/"/g, '\\"') + '"';
          }
          if (zoom) {
            snippet += ' zoom="' + zoom + '"';
          }
          if (marker) {
            snippet += ' marker="' + marker.replace(/"/g, '\\"') + '"';
          }
          snippet += ' >}}';
          shortcodeOutput.textContent = snippet;
          shortcodeOutput.dataset.code = snippet;
        }

        function setStatus(message, state) {
          statusMessage.textContent = message || '';
          if (state) {
            statusMessage.dataset.state = state;
          } else {
            statusMessage.removeAttribute('data-state');
          }
        }

        function updateMarker(preview, latlng, markerText) {
          if (!preview.marker) {
            preview.marker = L.marker(latlng).addTo(preview.map);
          } else {
            preview.marker.setLatLng(latlng);
          }

          if (markerText) {
            preview.marker.bindPopup(markerText);
          } else {
            preview.marker.unbindPopup();
          }
        }

        function updatePreviews(latlng, zoom, markerText) {
          [previewA, previewB].forEach(function(preview) {
            preview.map.setView(latlng, zoom);
            updateMarker(preview, latlng, markerText);
            preview.map.invalidateSize();
          });
        }

        function handleSuccess(latlng, zoom, markerText) {
          updatePreviews(latlng, zoom, markerText);
          setStatus('Vorschau aktualisiert.', 'success');
        }

        function geocodeLocation(loc, zoom, markerText) {
          const coords = parseCoordinates(loc);
          if (coords) {
            handleSuccess(coords, zoom, markerText);
            return;
          }

          setStatus('Standort wird gesucht …', 'loading');
          const url = 'https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q=' + encodeURIComponent(loc);
          fetch(url, {
            headers: {
              'Accept-Language': navigator.language || 'de'
            },
            referrerPolicy: 'no-referrer-when-downgrade'
          })
            .then(function(response) {
              if (!response.ok) {
                throw new Error('Standortsuche fehlgeschlagen.');
              }
              return response.json();
            })
            .then(function(result) {
              if (!Array.isArray(result) || result.length === 0) {
                throw new Error('Kein Ergebnis für "' + loc + '" gefunden.');
              }
              const item = result[0];
              const lat = parseFloat(item.lat);
              const lng = parseFloat(item.lon);
              if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                throw new Error('Ungültige Koordinaten erhalten.');
              }
              handleSuccess({ lat: lat, lng: lng }, zoom, markerText);
            })
            .catch(function(error) {
              setStatus(error.message || 'Standort konnte nicht geladen werden.', 'error');
            });
        }

        form.addEventListener('submit', function(event) {
          event.preventDefault();
          const loc = form.loc.value.trim();
          const zoom = Math.min(18, Math.max(1, parseInt(form.zoom.value, 10) || 12));
          const markerText = form.marker.value.trim();
          updateShortcode();
          geocodeLocation(loc, zoom, markerText);
        });

        form.addEventListener('input', function() {
          updateShortcode();
        });

        copyButton.addEventListener('click', function() {
          const code = shortcodeOutput.dataset.code || shortcodeOutput.textContent || '';
          if (!code) {
            return;
          }
          navigator.clipboard
            .writeText(code)
            .then(function() {
              setStatus('Shortcode kopiert!', 'success');
            })
            .catch(function() {
              setStatus('Konnte nicht kopieren. Bitte manuell kopieren.', 'error');
            });
        });

        // Initial render
        updateShortcode();
        const initialLoc = form.loc.value.trim();
        const initialZoom = parseInt(form.zoom.value, 10) || 12;
        const initialMarker = form.marker.value.trim();
        geocodeLocation(initialLoc, initialZoom, initialMarker);
      });
    </script>
  </body>
</html>
